package io.cucumber.java;

import io.cucumber.java.After;
import io.cucumber.java.Scenario;
import org.h2.store.fs.FileUtils;
import org.junit.jupiter.api.Test;
import org.junit.platform.commons.logging.Logger;
import org.junit.platform.commons.logging.LoggerFactory;
import org.openqa.selenium.*;
import org.openqa.selenium.WebDriver;

import javax.imageio.ImageIO;

import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.function.Supplier;

public class ScreenshotTest {

    private static WebDriver driver;
    private static final String FOLDER = "../uiuc.cs427.cucumber";
    private static final Logger logger = LoggerFactory.getLogger(ScreenshotTest.class);

    @After
    public void after(Scenario scenario) {
        if (scenario.isFailed()) {
            byte[] data = null;
            scenario.attach(data, "image/png", "My Test Screenshot When Scenario Fails");
        } // if
        if (!scenario.isFailed()) {
            byte[] data = null;
            scenario.attach(data, "image/png", "My Test Screenshot When Scenario Passes");
        } // if
    }// after

    @Test
    public void testTakeScreenShotElement() throws IOException {
        try {
            driver.get("https://www.perfecto.io/blog/cucumber-vs-selenium");
            takeScreenShot(driver.findElement(By.id("path-node page-node-type-blog")));
        } catch (Exception x) {
            logger.debug(new Supplier<String>() {
                public String get() {
                    return x.getMessage();
                }
            });
        }
    }// test

    @Test
    public void testTakeScreenShotElementEx() throws IOException {
        try {
            driver.get("https://docs.codecov.com/docs");
            takeScreenShot(driver.findElement(By.id("callout callout_warn")));
        } catch (Exception x) {
            logger.debug(new Supplier<String>() {
                public String get() {
                    return x.getMessage();
                }
            });
        }
    }// test

    @Test
    public void testTakeScreenShotElementExA() throws IOException {
        try {
            driver.get("https://www.oreilly.com/");
            takeScreenShot(driver.findElement(By.id("content")));
        } catch (Exception x) {
            logger.debug(new Supplier<String>() {
                public String get() {
                    return x.getMessage();
                }
            });
        }
    }// test

    public void takeScreenShot(WebElement element) throws IOException {
        File screen = ((TakesScreenshot) driver).getScreenshotAs(OutputType.FILE);
        Point p = element.getLocation();
        Rectangle rect = new Rectangle(0, 0, element.getSize().getWidth(), element.getSize().getHeight());
        BufferedImage img = ImageIO.read(screen);
        BufferedImage dest = img.getSubimage(p.getX(), p.getY(), rect.width, rect.height);
        ImageIO.write(dest, "png", screen);
        org.apache.commons.io.FileUtils.copyFile(screen, new File(FOLDER + System.nanoTime() + ".png"));
    }
}// class
